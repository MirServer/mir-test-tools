#!/bin/bash
set -xe

config_changes=0
mir_demo_server_config="${XDG_CONFIG_HOME}/mir/mir_demo_server.config"

# Ensure we have a config file with the fixed options
if [ ! -e "${mir_demo_server_config}" ]; then
mkdir -p $(dirname "${mir_demo_server_config}")
cat <<EOT > "${mir_demo_server_config}"
vt=4
console-provider=vt
wallpaper-font=$(dirname ${SNAP})/current/usr/share/fonts/truetype/freefont/FreeSansBold.ttf
EOT
fi

# As mir-kiosk HAS to run mesa-kms we can safely override the probe for KMS everywhere.
# This ensures the best possible diagnostics whenever we fail to start.
env_hacks=$(sed -n 's/^env-hacks=\(.*\)$/\1/p' ${miral_kiosk_config})
if [[ ! ${env_hacks} =~ .*MIR_MESA_KMS_DISABLE_MODESET_PROBE* ]]
then
  sed --in-place '/^env-hacks=/d' ${miral_kiosk_config}
  env_hacks=env-hacks=${env_hacks}:MIR_MESA_KMS_DISABLE_MODESET_PROBE
  echo ${env_hacks/=:/=} >> "${miral_kiosk_config}"
  let config_changes+=1
fi

# vt
vt=$(snapctl get vt)
if [ -n "${vt}" ]; then
  if [ -n "${vt//[0-9]}" ] || [ ! -e "/dev/tty$vt" ]; then
    echo "ERROR: '${vt}' is not a valid VT"
    exit 1
  fi

  if [ "vt=${vt}" != "$(grep vt= ${mir_demo_server_config})" ]; then
    if [ ${config_changes} -gt 0 ]; then
      sed --in-place       '/^vt/d' ${mir_demo_server_config}
    else
      sed --in-place=.save '/^vt/d' ${mir_demo_server_config}
    fi
    echo vt=${vt} >> ${mir_demo_server_config}
    let config_changes+=1
  fi
fi

# console-provider
console_provider=$(snapctl get console-provider)
if [ -n "${console_provider}" ]; then
  if [[ ! "${console_provider}" =~ ^(auto|logind|vt|none)$ ]]; then
    echo "ERROR: '${console_provider}' is not a valid console-provider option (auto|logind|vt|none)"
    exit 1
  fi

  if [ "console-provider=${console_provider}" != "$(grep console-provider= ${SNAP_DATA}/mir-demo-server.config)" ]; then
    if [ $config_changes -gt 0 ]; then
      sed --in-place       '/^console-provider/d' ${mir_demo_server_config}
    else
      sed --in-place=.save '/^console-provider/d' ${mir_demo_server_config}
    fi
    echo console-provider=${console_provider} >> ${mir_demo_server_config}
    let config_changes+=1
  fi
fi
